name: Send Brevo newsletter (Finbox HTML) — hourly + Paris gate + send only if changed

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: brevo-finbox-newsletter
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Gate: only run at 09:32 Europe/Paris
        shell: bash
        run: |
          PARIS_HM=$(TZ=Europe/Paris date +%H:%M)
          echo "Paris time is: $PARIS_HM"
          if [ "$PARIS_HM" != "09:32" ]; then
            echo "Not 09:32 in Europe/Paris. Exiting."
            exit 0
          fi

      - name: Checkout repo (to read/write last hash)
        uses: actions/checkout@v4

      - name: Read last sent hash from repo file
        id: last
        shell: bash
        run: |
          if [ -f .last_sent_hash.txt ]; then
            LAST=$(cat .last_sent_hash.txt | tr -d '\n' || true)
          else
            LAST=""
          fi
          echo "last=$LAST" >> "$GITHUB_OUTPUT"
          echo "Last hash: ${LAST:-<none>}"

      - name: Fetch remote HTML
        shell: bash
        run: |
          URL="https://raw.githubusercontent.com/guillaumedelannoy/finbox-data/main/Data/newsletter_payload_latest.html"
          curl -fsSL "$URL" -o newsletter.html
          test -s newsletter.html
          echo "Fetched HTML size: $(wc -c < newsletter.html) bytes"

      - name: Compute remote HTML hash
        id: hash
        shell: bash
        run: |
          SHA=$(sha256sum newsletter.html | awk '{print $1}')
          echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          echo "Remote SHA256: $SHA"

      - name: Decide whether to send
        id: decide
        shell: bash
        run: |
          CURRENT="${{ steps.hash.outputs.sha }}"
          LAST="${{ steps.last.outputs.last }}"
          if [ "$CURRENT" = "$LAST" ] && [ -n "$CURRENT" ]; then
            echo "No change detected. Skipping send."
            echo "send=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Change detected. Will send."
          echo "send=true" >> "$GITHUB_OUTPUT"

      - name: Send via Brevo Transactional API
        if: steps.decide.outputs.send == 'true'
        env:
          BREVO_API_KEY: ${{ secrets.BREVO_API_KEY }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_NAME: ${{ secrets.SENDER_NAME }}
          RECIPIENTS: ${{ secrets.RECIPIENTS }}
          SUBJECT_PREFIX: ${{ secrets.SUBJECT_PREFIX }}
        shell: bash
        run: |
          python - << 'PY'
          import os, json, datetime, urllib.request, urllib.error

          required = ["BREVO_API_KEY", "SENDER_EMAIL", "SENDER_NAME", "RECIPIENTS"]
          missing = [k for k in required if not os.environ.get(k)]
          if missing:
            raise SystemExit(f"Missing required secrets/env: {missing}")

          with open("newsletter.html", "r", encoding="utf-8") as f:
            html = f.read().strip()
          if not html:
            raise SystemExit("newsletter.html is empty.")

          recipients = [e.strip() for e in os.environ["RECIPIENTS"].split(",") if e.strip()]
          if not recipients:
            raise SystemExit("RECIPIENTS is empty after parsing.")
          to = [{"email": e} for e in recipients]

          subject_prefix = os.environ.get("SUBJECT_PREFIX") or "Finbox Daily"
          today = datetime.datetime.now().strftime("%Y-%m-%d")
          subject = f"{subject_prefix} — {today}"

          payload = {
            "sender": {"name": os.environ["SENDER_NAME"], "email": os.environ["SENDER_EMAIL"]},
            "to": to,
            "subject": subject,
            "htmlContent": html
          }

          print("Sending to:", recipients)
          print("Sender:", payload["sender"])
          print("Subject:", subject)

          req = urllib.request.Request(
            "https://api.brevo.com/v3/smtp/email",
            data=json.dumps(payload).encode("utf-8"),
            headers={
              "api-key": os.environ["BREVO_API_KEY"],
              "Content-Type": "application/json",
              "accept": "application/json"
            },
            method="POST"
          )

          try:
            with urllib.request.urlopen(req) as resp:
              body = resp.read().decode("utf-8")
              print("Brevo response:", body)
          except urllib.error.HTTPError as e:
            err = e.read().decode("utf-8", errors="replace")
            raise SystemExit(f"Brevo HTTPError {e.code}: {err}")
          PY

      - name: Update last hash file + commit (only after successful send)
        if: steps.decide.outputs.send == 'true'
        shell: bash
        run: |
          echo "${{ steps.hash.outputs.sha }}" > .last_sent_hash.txt

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .last_sent_hash.txt
          git commit -m "Update last sent hash" || exit 0
          git push
